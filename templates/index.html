{% extends "base.html" %}

{% block title %}Dashboard - Cmdarr{% endblock %}

{% block content %}
<div x-data="dashboard()" x-init="init()">
    <!-- Page Header -->
    <div class="mb-8">
        <h1 class="text-3xl font-bold text-gray-900 dark:text-white">Dashboard</h1>
        <p class="mt-2 text-gray-600 dark:text-gray-400">Overview of your Cmdarr music automation platform</p>
    </div>

    <!-- Status Cards -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
        <!-- System Status -->
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6 transition-colors duration-200">
            <div class="flex items-center">
                <div class="flex-shrink-0">
                    <div class="w-8 h-8 bg-green-100 rounded-full flex items-center justify-center">
                        <svg class="w-5 h-5 text-green-600" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" />
                        </svg>
                    </div>
                </div>
                <div class="ml-4">
                    <h3 class="text-sm font-medium text-gray-500 dark:text-gray-400">System Status</h3>
                    <p class="text-2xl font-semibold text-gray-900 dark:text-white" x-text="systemStatus || 'Loading...'"></p>
                </div>
            </div>
        </div>

        <!-- Enabled Commands -->
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6 transition-colors duration-200">
            <div class="flex items-center">
                <div class="flex-shrink-0">
                    <div class="w-8 h-8 rounded-full flex items-center justify-center"
                         :class="enabledCommands === null ? 'bg-gray-100' : (enabledCommands > 0 ? 'bg-green-100' : 'bg-red-100')">
                        <svg class="w-5 h-5" 
                             :class="enabledCommands === null ? 'text-gray-600' : (enabledCommands > 0 ? 'text-green-600' : 'text-red-600')"
                             fill="currentColor" viewBox="0 0 20 20">
                            <!-- Loading spinner -->
                            <path x-show="enabledCommands === null" fill-rule="evenodd" d="M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.601 2.566 1 1 0 11-1.885.666A5.002 5.002 0 005.999 7H9a1 1 0 010 2H4a1 1 0 01-1-1V3a1 1 0 011-1zm.008 9.057a1 1 0 011.276.61A5.002 5.002 0 0014.001 13H11a1 1 0 110-2h5a1 1 0 011 1v5a1 1 0 11-2 0v-2.101a7.002 7.002 0 01-11.601-2.566 1 1 0 01.61-1.276z" clip-rule="evenodd" />
                            <!-- Green checkmark for enabled commands -->
                            <path x-show="enabledCommands !== null && enabledCommands > 0" fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" />
                            <!-- Red X for no enabled commands -->
                            <path x-show="enabledCommands !== null && enabledCommands === 0" fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" />
                        </svg>
                    </div>
                </div>
                <div class="ml-4">
                    <h3 class="text-sm font-medium text-gray-500 dark:text-gray-400">Enabled Commands</h3>
                    <p class="text-2xl font-semibold text-gray-900 dark:text-white" x-text="enabledCommands !== null ? enabledCommands : 'Loading...'"></p>
                </div>
            </div>
        </div>

        <!-- Active Command -->
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6 transition-colors duration-200">
            <div class="flex items-center">
                <div class="flex-shrink-0">
                    <div class="w-8 h-8 rounded-full flex items-center justify-center"
                         :class="activeCommand === null ? 'bg-gray-100' : (activeCommand ? 'bg-yellow-100' : 'bg-green-100')">
                        <svg class="w-5 h-5" 
                             :class="activeCommand === null ? 'text-gray-600' : (activeCommand ? 'text-yellow-600' : 'text-green-600')"
                             fill="currentColor" viewBox="0 0 20 20">
                            <!-- Loading spinner -->
                            <path x-show="activeCommand === null" fill-rule="evenodd" d="M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.601 2.566 1 1 0 11-1.885.666A5.002 5.002 0 005.999 7H9a1 1 0 010 2H4a1 1 0 01-1-1V3a1 1 0 011-1zm.008 9.057a1 1 0 011.276.61A5.002 5.002 0 0014.001 13H11a1 1 0 110-2h5a1 1 0 011 1v5a1 1 0 11-2 0v-2.101a7.002 7.002 0 01-11.601-2.566 1 1 0 01.61-1.276z" clip-rule="evenodd" />
                            <!-- Yellow clock for running command -->
                            <path x-show="activeCommand !== null && activeCommand" fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clip-rule="evenodd" />
                            <!-- Green checkmark for idle -->
                            <path x-show="activeCommand !== null && !activeCommand" fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" />
                        </svg>
                    </div>
                </div>
                <div class="ml-4">
                    <h3 class="text-sm font-medium text-gray-500 dark:text-gray-400">Active Command</h3>
                    <p class="text-lg font-semibold text-gray-900 dark:text-white" x-text="activeCommand === null ? 'Loading...' : activeCommand"></p>
                </div>
            </div>
        </div>

        <!-- Configuration Status -->
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6 transition-colors duration-200">
            <div class="flex items-center">
                <div class="flex-shrink-0">
                    <div class="w-8 h-8 rounded-full flex items-center justify-center" 
                         :class="configStatus === 'Valid' ? 'bg-green-100' : 'bg-red-100'">
                        <svg class="w-5 h-5" 
                             :class="configStatus === 'Valid' ? 'text-green-600' : 'text-red-600'"
                             fill="currentColor" viewBox="0 0 20 20">
                            <!-- Green checkmark for valid config -->
                            <path x-show="configStatus === 'Valid'" fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" />
                            <!-- Red X for invalid config -->
                            <path x-show="configStatus !== 'Valid'" fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" />
                        </svg>
                    </div>
                </div>
                <div class="ml-4">
                    <h3 class="text-sm font-medium text-gray-500 dark:text-gray-400">Configuration</h3>
                    <p class="text-2xl font-semibold text-gray-900 dark:text-white" x-text="configStatus || 'Loading...'"></p>
                </div>
            </div>
        </div>
    </div>

    <!-- Recent Activity -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
        <!-- Recent Command Executions -->
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow transition-colors duration-200">
            <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700">
                <h3 class="text-lg font-medium text-gray-900 dark:text-white">Recent Command Executions</h3>
            </div>
            <div class="p-6">
                <div x-show="!recentExecutions.length" class="text-center py-8">
                    <svg class="mx-auto h-12 w-12 text-gray-400 dark:text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" />
                    </svg>
                    <h3 class="mt-2 text-sm font-medium text-gray-900 dark:text-white">No executions yet</h3>
                    <p class="mt-1 text-sm text-gray-500 dark:text-gray-400">Command executions will appear here once they run.</p>
                </div>
                
                <div x-show="recentExecutions.length" class="space-y-4">
                    <template x-for="execution in recentExecutions" :key="execution.id">
                        <div class="flex items-center justify-between p-4 bg-gray-50 dark:bg-gray-700 rounded-lg transition-colors duration-200">
                            <div class="flex items-center space-x-3">
                                <div class="flex-shrink-0">
                                    <!-- Running status (yellow clock) -->
                                    <div x-show="execution.status === 'running'" 
                                         class="w-8 h-8 rounded-full bg-yellow-100 dark:bg-yellow-900 flex items-center justify-center">
                                        <svg class="w-4 h-4 text-yellow-600 dark:text-yellow-400" 
                                             fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                                        </svg>
                                    </div>
                                    
                                    <!-- Success status (green check) -->
                                    <div x-show="execution.status === 'completed' && execution.success" 
                                         class="w-8 h-8 rounded-full bg-green-100 dark:bg-green-900 flex items-center justify-center">
                                        <svg class="w-4 h-4 text-green-600 dark:text-green-400" 
                                             fill="currentColor" viewBox="0 0 20 20">
                                            <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
                                        </svg>
                                    </div>
                                    
                                    <!-- Failed status (red X) -->
                                    <div x-show="execution.status === 'completed' && !execution.success || execution.status === 'failed'" 
                                         class="w-8 h-8 rounded-full bg-red-100 dark:bg-red-900 flex items-center justify-center">
                                        <svg class="w-4 h-4 text-red-600 dark:text-red-400" 
                                             fill="currentColor" viewBox="0 0 20 20">
                                            <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" />
                                        </svg>
                                    </div>
                                </div>
                                <div>
                                    <p class="text-sm font-medium text-gray-900 dark:text-white" x-text="getFriendlyCommandName(execution.command_name)"></p>
                                    <p class="text-sm text-gray-500 dark:text-gray-400" x-text="formatDate(execution.started_at)"></p>
                                    <p x-show="execution.target && execution.target !== 'unknown'" class="text-xs text-blue-600 dark:text-blue-400 font-medium" x-text="'Target: ' + execution.target.toUpperCase()"></p>
                                </div>
                            </div>
                            <div class="text-right">
                                <p class="text-sm text-gray-900 dark:text-white" x-text="execution.duration ? formatDuration(execution.duration) : 'Running...'"></p>
                                <p class="text-xs text-gray-500 dark:text-gray-400" x-text="execution.triggered_by"></p>
                            </div>
                        </div>
                    </template>
                </div>
            </div>
        </div>

        <!-- System Information -->
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow transition-colors duration-200">
            <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700">
                <h3 class="text-lg font-medium text-gray-900 dark:text-white">System Information</h3>
            </div>
            <div class="p-6">
                <dl class="space-y-4">
                    <div>
                        <dt class="text-sm font-medium text-gray-500 dark:text-gray-400">Version</dt>
                        <dd class="mt-1 text-sm text-gray-900 dark:text-white" x-text="systemInfo.version || 'Loading...'"></dd>
                    </div>
                    <div>
                        <dt class="text-sm font-medium text-gray-500 dark:text-gray-400">Uptime</dt>
                        <dd class="mt-1 text-sm text-gray-900 dark:text-white" x-text="systemInfo.uptime_seconds ? formatDuration(systemInfo.uptime_seconds) : 'Loading...'"></dd>
                    </div>
                    <div>
                        <dt class="text-sm font-medium text-gray-500 dark:text-gray-400">Database Status</dt>
                        <dd class="mt-1 text-sm text-gray-900 dark:text-white" x-text="databaseStatus || 'Loading...'"></dd>
                    </div>
                    <div>
                        <dt class="text-sm font-medium text-gray-500 dark:text-gray-400">Python Version</dt>
                        <dd class="mt-1 text-sm text-gray-900 dark:text-white" x-text="systemInfo.python_version || 'Loading...'"></dd>
                    </div>
                </dl>
            </div>
        </div>
    </div>
</div>

<script>
function dashboard() {
    return {
        // Data
        systemStatus: null,
        enabledCommands: null,
        activeCommand: null,
        configStatus: null,
        databaseStatus: null,
        recentExecutions: [],
        systemInfo: {},
        websocket: null,
        commands: [], // Store commands for display name lookup
        
        // Initialize dashboard
        init() {
            this.setupWebSocket();
            this.loadDashboard();
        },
        
        // Get friendly command name
        getFriendlyCommandName(commandName) {
            const command = this.commands.find(cmd => cmd.command_name === commandName);
            return command ? command.display_name : commandName;
        },
        
        setupWebSocket() {
            try {
                const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
                const wsUrl = `${protocol}//${window.location.host}/ws`;
                this.websocket = new WebSocket(wsUrl);
                
                this.websocket.onopen = () => {
                    console.log('Dashboard WebSocket connected');
                };
                
                this.websocket.onmessage = (event) => {
                    try {
                        const data = JSON.parse(event.data);
                        this.handleWebSocketMessage(data);
                    } catch (error) {
                        console.error('Failed to parse WebSocket message:', error);
                    }
                };
                
                this.websocket.onclose = () => {
                    console.log('Dashboard WebSocket disconnected, attempting to reconnect...');
                    setTimeout(() => this.setupWebSocket(), 5000);
                };
                
                this.websocket.onerror = (error) => {
                    console.error('Dashboard WebSocket error:', error);
                };
                
            } catch (error) {
                console.error('Failed to setup dashboard WebSocket:', error);
            }
        },
        
        handleWebSocketMessage(data) {
            if (data.type === 'command_update') {
                this.updateCommandStatus(data.command_name, data.data);
            }
        },
        
        updateCommandStatus(commandName, data) {
            if (data.status === 'started') {
                // Command started running - get friendly name
                const command = this.commands.find(cmd => cmd.command_name === commandName);
                this.activeCommand = command ? command.display_name : commandName;
            } else if (data.status === 'completed') {
                // Command completed
                this.activeCommand = null;
                // Refresh dashboard data to get updated stats
                this.loadDashboard();
            }
        },
        
        getCommandDisplayName(commandName) {
            const command = this.commands.find(cmd => cmd.command_name === commandName);
            return command ? command.display_name : commandName;
        },
        
        // Load dashboard data
        async loadDashboard() {
            try {
                // Load commands for display name lookup
                const commandsResponse = await this.apiCall('/api/commands/');
                this.commands = commandsResponse;
                
                // Load status data
                const statusData = await this.apiCall('/api/status/commands');
                this.enabledCommands = statusData.enabled_commands;
                
                // Determine active command (since only one can run at a time)
                const runningCommand = statusData.commands.find(cmd => cmd.is_running);
                this.activeCommand = runningCommand ? runningCommand.display_name : "No Running Command";
                
                // Load recent executions
                const executionsData = await this.apiCall('/api/status/executions/recent?limit=5');
                this.recentExecutions = executionsData.executions || [];
                
                // Load system info
                const systemData = await this.apiCall('/api/status/system');
                this.systemInfo = systemData;
                
                // Load health status for database
                const healthData = await this.apiCall('/api/status/health');
                this.databaseStatus = healthData.checks?.database?.status === 'healthy' ? 'Connected' : 'Disconnected';
                
                // Determine system status
                this.systemStatus = 'Healthy';
                this.configStatus = 'Valid';
                
            } catch (error) {
                console.error('Failed to load dashboard:', error);
                this.systemStatus = 'Error';
                this.configStatus = 'Invalid';
            }
        }
    }
}
</script>
{% endblock %}
